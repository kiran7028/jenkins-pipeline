pipeline {
    agent any

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Trivy Scans') {
            agent {
                docker {
                    image 'aquasec/trivy:latest'
                    args '--entrypoint=""'
                }
            }
            steps {
                sh """
                    echo "===== Trivy Filesystem Scan ====="
                    trivy fs .

                    echo "===== Trivy Remote Repo Scan ====="
                    trivy repo \
                      --format sarif \
                      -o trivy-report.sarif \
                      https://github.com/kiran7028/jenkins-pipeline.git
                """
            }
        }

    }

    post {
        always {
            echo "Saving Trivy reports..."
            archiveArtifacts artifacts: 'trivy-report.*', fingerprint: true
        }
    }
}
