pipeline {
    agent any
    
    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Trivy FS Scan') {
            steps {
                sh """
                    echo "===== Running Trivy Filesystem Scan ====="
                    /opt/homebrew/bin/trivy fs .
                """
            }
        }

        stage('Trivy Repo Scan') {
            steps {
                sh """
                    echo "===== Running Trivy Remote Repo Scan ====="
                    /opt/homebrew/bin/trivy repo \
                      --format sarif \
                      -o trivy-report.sarif \
                      https://github.com/kiran7028/jenkins-pipeline.git
                """
            }
        }

        stage('Trivy Image Scan') {
            steps {
                sh """
                    echo "===== Running Trivy Image Scan ====="
                    
                    
                    /opt/homebrew/bin/trivy image nginx:latest \
                        --format json \
                        --severity HIGH \
                        --output trivy-results.json

                    /opt/homebrew/bin/trivy image nginx:latest \
                        --format table \
                        --severity HIGH \
                        --output trivy-results.html
                    
                    echo "==========trivy-results.html=========="
                    cat trivy-results.html
                """
            }
        }
    }

    post {
        always {
            echo "Archiving Trivy SARIF report..."
            archiveArtifacts artifacts: 'trivy-report.*', fingerprint: true
        }
    }
}